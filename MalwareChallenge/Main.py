import ASMKeyword as asmk
import ByteEncoder as bytee
import FileEnumerator as filee
import numpy as np
import random
from sklearn import neighbors
from sklearn.metrics import accuracy_score, log_loss
from sklearn.multiclass import OneVsRestClassifier

def train(magic):
    print "Loading training set...[ASM]"
    full_asm = [(asmk.ASMKeyword(root+x).normal_dict(), enum.malware_class[x]) for x in enum.next_files(250, ".asm")]
    full_asm = [x for x in full_asm if x[0] is not None]

    print "Parsing training set...[ASM]"
    data_asm = [x[0] for x in full_asm]
    label_asm = [x[1] for x in full_asm]

    print "Loading training set...[BYTES]"
    full_byte = [(bytee.CAE(), enum.malware_class[x]) for x in enum.next_files(250, ".bytes")]
    full_byte = [x for x in full_byte if x[0] is not None]
    
    print "Parsing training set...[BYTES]"
    data_byte = [x[0] for x in full_byte]
    label_byte = [x[1] for x in full_byte]

    magic.fit(data_asm, label_asm)

def test(magic):
    print "Loading testing set...[ASM]"
    full_asm = [(asmk.ASMKeyword(root+x).normal_dict(), enum.malware_class[x]) for x in enum.next_files(250, ".asm")]
    full_asm = [x for x in full_asm if x[0] is not None]
    
    print "Parsing testing set...[ASM]"
    data_asm = [x[0] for x in full_asm]
    label_asm = [x[1] for x in full_asm]

    print "Loading testing set...[BYTES]"
    full_byte = [(bytee.CAE(), enum.malware_class[x]) for x in enum.next_files(250, ".bytes")]
    full_byte = [x for x in full_byte if x[0] is not None]

    print "Parsing testing set...[ASM]"
    data_byte = [x[0] for x in full_byte]
    label_byte = [x[1] for x in full_byte]

root = "~/Documents/DATA/malware_dump/"

enum = filee.FileEnumerator("~/Downloads/trainLabels.csv", root)

print "Training model..."
magic = neighbors.KNeighborsClassifier(weights="distance")
train(magic)

print "Testing model..."
print accuracy_score(asm_test_label, magic.predict(asm_test_data))
print log_loss(asm_test_label, magic.predict_proba(asm_test_data))
