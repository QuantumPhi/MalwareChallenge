import ASMEnumerator as asme
import ASMKeyword as asmk
import ByteEncoder as bytee
import ByteEnumerator as byteen
import numpy as np
import random
import sklearn.ensemble as en
from sklearn import neighbors
from sklearn.metrics import accuracy_score, log_loss


def train(magic, asm, byte):
    print "Loading training set...[ASM]"
    full_asm = [(asmk.ASMKeyword(root + x).normal_dict(), asm.malware_class[x]) for x in asm.next_files(250)]
    full_asm = [x for x in full_asm if x[0] is not None]

    print "Parsing training set...[ASM]"
    data_asm = [x[0] for x in full_asm]
    label_asm = [x[1] for x in full_asm]

    print "Loading training set...[BYTES]"
    full_byte = [(int(str(x[1:].split()), 16), byte.malware_class[x]) for x in byte.next_files(250)]
    full_byte = [x for x in full_byte if x[0] is not None]
    
    print "Parsing training set...[BYTES]"
    data_byte = [x[0] for x in full_byte]
    label_byte = [x[1] for x in full_byte]

    magic.fit(data_byte, label_byte)

def test(magic, asm, byte):
    print "Loading testing set...[ASM]"
    full_asm = [(asmk.ASMKeyword(root + x).normal_dict(), asm.malware_class[x]) for x in asm.next_files(250)]
    full_asm = [x for x in full_asm if x[0] is not None]
    
    print "Parsing testing set...[ASM]"
    data_asm = [x[0] for x in full_asm]
    label_asm = [x[1] for x in full_asm]

    print "Loading testing set...[BYTES]"
    full_byte = [(int(str(x[1:].split()), 16), byte.malware_class[x]) for x in byte.next_files(250)]
    full_byte = [x for x in full_byte if x[0] is not None]

    print "Parsing testing set...[BYTES]"
    data_byte = [x[0] for x in full_byte]
    label_byte = [x[1] for x in full_byte]

    print accuracy_score(label_byte, magic.predict(data_byte))
    print log_loss(label_byte, magic.predict_proba(data_byte))

root = "~/Documents/DATA/malware_dump/"

asm = asme.ASMEnumerator("~/Downloads/trainLabels.csv", root)
byte = byteen.ByteEnumerator("~/Downloads/trainLabels.csv", root)

print "Training model..."
magic = en.ExtraTreesClassifier(n_estimators=100, criterion='entropy')
train(magic, asm, byte)

print "Testing model..."
test(magic, asm, byte)
